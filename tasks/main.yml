---
# tasks file for unbound

- name: Wait for systemd to complete initialization. # noqa 303
  command: systemctl is-system-running
  register: systemctl_status
  until: >
    'running' in systemctl_status.stdout or
    'degraded' in systemctl_status.stdout
  retries: 30
  delay: 5
  when: (ansible_service_mgr == 'systemd' and ansible_distribution == 'Fedora')
  changed_when: false

- name: Populate service facts
  shell: |
    set -o pipefail
    systemctl is-enabled systemd-resolved
  args:
    executable: /bin/bash
  check_mode: no
  failed_when: systemd_resolved_status.rc >= 2
  changed_when: false
  register: systemd_resolved_status

- name: disable systemd-resolved
  include: systemd-resolved.yml
  when: ('enabled' in systemd_resolved_status.stdout)

- name: start install
  include: install.yml

- name: start configure
  include: configure.yml

- name: start ssl config
  include: ssl-certs.yml
  when: enable_dot or enable_doh

- name: flush handlers
  meta: flush_handlers

- name: start doh/dot config
  include: doh-dot-server.yml
  when: enable_dot or enable_doh

- name: start dnscrypt config
  include: dnscrypt.yml
  when: enable_dnscrypt

- name: restart unbound to enable all settings
  systemd:
    name: unbound
    state: restarted
    enabled: yes
    daemon_reload: yes
  changed_when: false
